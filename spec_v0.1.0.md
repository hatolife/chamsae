# ハングルIME 仕様書

## 概要

ローマ字入力から韓国語ハングル文字への変換を行うIME (Input Method Editor) の仕様。

### 目的

- Rust学習を兼ねたIME自作
- Windows TSF (Text Services Framework) での動作を目標
- 学習目的のためシンプルな設計を優先

### 対象環境

- OS: Windows 11 (優先), Linux (Debian)
- 言語: Rust
- 現在のフェーズ: 変換ロジック (CLIツール)

---

## ハングル文字構造

ハングルは「初声 + 中声 + 終声(任意)」の3要素で構成される。

```
가 = ㄱ(初声) + ㅏ(中声)
강 = ㄱ(初声) + ㅏ(中声) + ㅇ(終声)
```

### Unicode計算式

```
ハングル文字 = 0xAC00 + (初声 × 21 + 中声) × 28 + 終声
```

- ハングル範囲: U+AC00 〜 U+D7A3 (11,172文字)

---

## ローマ字マッピング

### 初声 (子音) - 19種類

| インデックス | ハングル | ローマ字 | 分類 |
|-------------|---------|----------|------|
| 0 | ㄱ | g | 基本 |
| 1 | ㄲ | kk | 濃音 |
| 2 | ㄴ | n | 基本 |
| 3 | ㄷ | d | 基本 |
| 4 | ㄸ | tt | 濃音 |
| 5 | ㄹ | r, l | 基本 |
| 6 | ㅁ | m | 基本 |
| 7 | ㅂ | b | 基本 |
| 8 | ㅃ | pp | 濃音 |
| 9 | ㅅ | s | 基本 |
| 10 | ㅆ | ss | 濃音 |
| 11 | ㅇ | (なし) | 無音 |
| 12 | ㅈ | j | 基本 |
| 13 | ㅉ | jj | 濃音 |
| 14 | ㅊ | ch | 激音 |
| 15 | ㅋ | k | 激音 |
| 16 | ㅌ | t | 激音 |
| 17 | ㅍ | p | 激音 |
| 18 | ㅎ | h | 基本 |

### 中声 (母音) - 21種類

| インデックス | ハングル | ローマ字 | 分類 |
|-------------|---------|----------|------|
| 0 | ㅏ | a | 基本 |
| 1 | ㅐ | ae | 合成 |
| 2 | ㅑ | ya | ヤ行 |
| 3 | ㅒ | yae | ヤ行合成 |
| 4 | ㅓ | eo | 基本 |
| 5 | ㅔ | e | 基本 |
| 6 | ㅕ | yeo | ヤ行 |
| 7 | ㅖ | ye | ヤ行 |
| 8 | ㅗ | o | 基本 |
| 9 | ㅘ | wa | ワ行 |
| 10 | ㅙ | wae | ワ行合成 |
| 11 | ㅚ | oe | 合成 |
| 12 | ㅛ | yo | ヤ行 |
| 13 | ㅜ | u | 基本 |
| 14 | ㅝ | wo | ワ行 |
| 15 | ㅞ | we | ワ行 |
| 16 | ㅟ | wi | ワ行 |
| 17 | ㅠ | yu | ヤ行 |
| 18 | ㅡ | eu | 基本 |
| 19 | ㅢ | ui | 合成 |
| 20 | ㅣ | i | 基本 |

### 終声 (パッチム) - 28種類 (0=なし含む)

| インデックス | ハングル | ローマ字 | 分類 |
|-------------|---------|----------|------|
| 0 | (なし) | - | なし |
| 1 | ㄱ | g | 基本 |
| 2 | ㄲ | kk | 濃音 |
| 3 | ㄳ | gs | 二重 |
| 4 | ㄴ | n | 基本 |
| 5 | ㄵ | nj | 二重 |
| 6 | ㄶ | nh | 二重 |
| 7 | ㄷ | d | 基本 |
| 8 | ㄹ | l | 基本 |
| 9 | ㄺ | lg | 二重 |
| 10 | ㄻ | lm | 二重 |
| 11 | ㄼ | lb | 二重 |
| 12 | ㄽ | ls | 二重 |
| 13 | ㄾ | lt | 二重 |
| 14 | ㄿ | lp | 二重 |
| 15 | ㅀ | lh | 二重 |
| 16 | ㅁ | m | 基本 |
| 17 | ㅂ | b | 基本 |
| 18 | ㅄ | bs | 二重 |
| 19 | ㅅ | s | 基本 |
| 20 | ㅆ | ss | 濃音 |
| 21 | ㅇ | ng | 基本 |
| 22 | ㅈ | j | 基本 |
| 23 | ㅊ | ch | 激音 |
| 24 | ㅋ | k | 激音 |
| 25 | ㅌ | t | 激音 |
| 26 | ㅍ | p | 激音 |
| 27 | ㅎ | h | 基本 |

---

## 入力規則

### スペース処理

| 入力 | 意味 | 出力例 |
|------|------|--------|
| 半角スペース1つ | 音節区切り | `han gug` → 한국 |
| 半角スペース2つ | 実際のスペース出力 | `han  gug` → 한 국 |
| 半角スペース3つ | スペース1つ + 区切り | `han   gug` → 한 국 |
| 半角スペース4つ | スペース2つ出力 | `han    gug` → 한  국 |

### 音節境界の曖昧性

ローマ字変換には本質的な曖昧性がある。

```
"hangugeo" の解釈:
- han + gu + geo = 한구거 (曖昧性により)
- han + gug + eo = 한국어 (正しい意味)
```

**解決策**: スペースで音節を明示的に区切る

```
"han gug eo" → 한국어 (正確)
```

### 終声判定ルール

終声の後に「子音+母音」が続く場合、終声を採用する (子音が次の初声になる)。

```
"han gug" → han(終声n) + gug(初声g) → 한국
```

終声の後に「母音のみ」が続く場合、より短い終声を試す。

```
"nge" → ng終声にしない → n終声 + ge → ㄴ게 ではなく...
実際: 母音eの前でngを分割 → n + ge
```

### 大文字小文字

大文字小文字は区別しない (内部で小文字に変換)。

```
"HAN GUG" → 한국
"AnNyEoNg" → 안녕
```

### 未対応文字

マッピングにない文字はそのまま出力される。

```
"han gug 123" → 한국123
"hello!" → 헬로! (要確認: helloの変換結果)
```

未対応のアルファベット: c, f, q, v, x, z

---

## 変換アルゴリズム

### 処理フロー

```
1. 入力文字列を小文字に変換
2. スペースで分割処理
   - 連続スペースをカウント
   - 2スペースごとに実際のスペースを出力
3. 各音節群を変換
   a. 初声を最長一致で検索
   b. 中声を最長一致で検索
   c. 終声を先読み付きで検索
   d. Unicode合成してハングル文字を生成
4. 結果を連結して出力
```

### 最長一致検索

複数の候補がある場合、長い方を優先する。

```
入力: "ssa"
候補: "s"(9), "ss"(10)
結果: "ss"を採用 → 싸
```

---

## テストカバレッジ

### 要素テスト

| カテゴリ | テスト数 | カバー率 |
|----------|---------|----------|
| 初声 (基本) | 10 | 100% |
| 初声 (激音) | 4 | 100% |
| 初声 (濃音) | 5 | 100% |
| 初声 (完全) | 19 | 100% |
| 中声 (完全) | 21 | 100% |
| 終声 (完全) | 27 | 100% |

### 機能テスト

| カテゴリ | 内容 |
|----------|------|
| 音節境界 | スペース区切り、連続音節 |
| スペース処理 | 単一、ダブル、複数 |
| エッジケース | 空文字、未対応文字、大文字 |
| 連音化 | 終声→初声の移動 |
| 複合パターン | 濃音+複合母音、激音+複合母音 |

### 実用テスト

| カテゴリ | 例 |
|----------|-----|
| 基本単語 | 물, 불, 밥, 집, 책 |
| 挨拶 | 안녕하세요, 감사합니다 |
| 動詞活用 | 먹었다, 가고있다 |
| 外来語 | 커피, 컴퓨터, 텔레비전 |
| 地名 | 대한민국, 경복궁, 인천국제공항 |
| 文章 | 나는 학생 입니다 |

---

## 制限事項

### 現在の制限

1. **辞書なし**: 統計的/辞書的な曖昧性解消なし
2. **リアルタイム変換なし**: 確定後の変換のみ
3. **変換候補なし**: 単一の変換結果のみ
4. **IME統合なし**: 現在はCLIツールのみ

### 将来の拡張予定

1. **Phase 2**: Windows API入門
2. **Phase 3**: TSF IME実装
3. **リアルタイム再構成**: キー入力単位での処理
4. **候補表示**: 複数の変換候補

---

## ファイル構成

```
hangul_ime/
├── Cargo.toml
├── Makefile
├── spec.md          # 本仕様書
└── src/
    ├── main.rs      # CLIエントリポイント
    └── hangul.rs    # 変換ロジック + テスト
```

---

## 使用方法

### ビルド

```bash
cargo build --release
```

### 実行

```bash
# 単一変換
hangul_ime -i "an nyeong ha se yo"
# 出力: 안녕하세요

# インタラクティブモード
hangul_ime -I
> han gug eo
  → 한국어
> exit
```

### テスト

```bash
cargo test
```
